# Como trabalhar no R
  
Se você já tem uma noção de R, mas ainda sente dificuldade em organizar seu fluxo de trabalho, este capítulo é para você! Utilizaremos técnicas de ciência de dados e repositórios como o GitHub para tornar o trabalho no R prazeroso e eficiente!

Iremos utilizar o banco de dados ficticios que possui erros comuns que podemos utilizar para aprender a lidar com eles sem precisar de utilizar o Excel.
  
Baixe a planilha fake e veja que ela possui quatro variaveis (ID, peso, numero de parasitas e local) coletadas do passarinho bem-te-vi.
  
 [Clique aqui para baixar a planilha ficticia](data/fake_data.xlsx)

Vamos importar a planilha fictícia mais para frente. Relaxe aí e finja que ela é sua.
  
## Criando um projeto de R
  
Imaginemos que precisamos analisar um banco de dados de algum projeto. O primeiro passo eh criar um projeto de R, para isso voce vai no canto superior direito do RStudio (proximo a janela de environment e history) e clica:
  
**project (none)" > new project > new directory > new project**
  
Ao clicar em "New Project", aparecerá uma janela para escolher o nome do projeto e o local no computador onde seu projeto irá ficar. Coloque o nome desejado (sugestão: "projeto_caranguejo"), selecione qualquer pasta no computador (sugestão: desktop) e clique em "Criar Projeto".

Se você fez tudo direitinho, o RStudio estará da seguinte forma. Note que ao invés de "Project (None)", estará o nome do projeto que você criou.
  
![](img/tela_do_projeto.png)
  
Sugiro, meu nobre consagrado Rzeiro, que você vá no local do computador onde você criou o projeto e veja a pasta, veja o arquivo de R que foi criado. Você também pode fazer isso utilizando a janela de "Files", onde mostrará todas as pastas do seu diretório que, a partir de agora, será a pasta que o seu arquivo de projeto de R está situado. Todos os scripts, arquivos e planilhas que você irá utilizar nas suas análises, ficarão dentro da pasta do projeto. Isso significa que vai ficar tudo solto, bagunçado? Claro que não. Iremos criar pastas organizadas onde hospedarão cada coisa que iremos trabalhar, como por exemplo: dados brutos, dados processados, scripts, outputs, etc. Você pode criar manualmente, mas por que faríamos isso se temos o R para fazer por nós?

## Organizando o projeto de R
  
Para criar as pastas de forma organizada, voce pode fazer manualmente ou utilizando o pacote "here".

```r
install.packages("here")
library(here)
```
  
Após a instalação do pacote "here", iremos criar uma função que criará as pastas automaticamente no nosso diretório. Não se assuste com o script da função, ela é mais simples do que parece e você não precisa entendê-lo por completo. Apenas rode o código para criar a função e depois rode o código que utiliza a função para criar as pastas.

Antes de rodar o código, certifique-se de que você está no projeto de R que você criou.
  
```r
# Criando funcao para criacao das pastas do projeto
# Codigo disponibilizado pelo Gustavo Paterno (https://github.com/paternogbc)

build_project <- function(type = "analysis",
                          temp = TRUE) {
  
  if(type == "analysis"){
    # Data
    dir.create(path = here::here("data"))
    dir.create(path = here::here("data", "raw"))
    dir.create(path = here::here("data", "processed"))
    
    # outputs
    dir.create(path = here::here("outputs"))
    dir.create(path = here::here("outputs", "figures"))
    dir.create(path = here::here("outputs", "tables"))
    if(isTRUE(temp)){
      dir.create(path = here::here("outputs", "temp"))
    }
    
    # scripts
    dir.create(path = here::here("scripts"))
    
    # docs
    #dir.create(path = here::here("docs")) #para criar a pasta docs, so tirar o comentario dessa linha
  }
}

#Utilizando a funcao criada para gerar as pastas
build_project(type = "analysis",
              temp = TRUE) #se FALSE, nao cria a pasta temp.
```
  
  Se tudo ocorreu bem, as pastas estao assim:
  
![](img/pastas_do_projeto.png)
  
Dentro da pasta "data", você encontra as subpastas "raw" e "processed". Em "outputs", você encontra as subpastas "figures", "temp" e "tables". Em "script", você não encontrará nada (por enquanto). O arquivo com o símbolo do R "projeto_caranguejos.Rproj" é o seu projeto de R. Você pode abri-lo (dando duplo clique) toda vez que você for trabalhar no projeto. Isso abrirá o RStudio já com o seu projeto aberto e pronto para trabalhar.

- Feche o RStudio e abra-o novamente dando clique duplo no seu projeto de R.

Agora você tem tudo pronto para começar a trabalhar com um fluxo de trabalho eficiente e reprodutível!
  
## Trabalhando em um projeto de R
 
Antes de tudo baixe a planilha de dados ficticios (caso nao tenha baixado ainda) de uma especie de passarinho (tambem ficticia), que contem informacoes ficticias sobre peso (g) e quantidade de parasitas de tres diferentes localidades do bem-te-vi:
 
 [Clique aqui para baixar a planilha ficticia](data/fake_data.xlsx)
 
Na pasta **data > raw**, você adiciona sua planilha de dados brutos fictícia (fake_data.xlsx). O fluxo de trabalho será o mais simples possível, mas envolverá etapas essenciais da análise de dados.
  
**Limpar dados brutos > Realizar análise > Mostrar gráficos**
  
Para limpar a planilha de dados brutos, iremos criar um script para isso. Utilizaremos funções do pacote *dplyr* para modificar nomes das variáveis, nomes dos fatores, analisar dados faltantes, entre outras coisas.
  
### Etapa 1: limpar dados

 Vamos criar um script para limpar nossos dados brutos. Monte o script completo utilizando os codigos que irei fornecendo a seguir copiando e colando no seu RStudio. Assim, a primeira coisa que iremos fazer do script eh seu cabecalho. Utilizaremos os comentarios para criar um cabecalho com as informacoes de titulo, autores e data. 
  
 ```r
 
# Script to load and clean raw data flores iris
# Author: Marilia T. Ericcson
# Data: 2019-11-06

```
  
Após isso, utilizaremos os comentários para organizar o script em tópicos, fazendo isso manualmente ou utilizando o atalho: **Ctrl + Shift + R**. A primeira parte do código é a instalação dos pacotes que iremos utilizar no processo.
  
```r

# Packages -------------------------------------------------------------
# Caso nao tenha os pacotes instalados, instale!

library(dplyr)  #Pacote com funcoes para manipular dados
library(readlx) #Pacote com funcao para importar planilha em formato de excel (xlsx)
```
Segundo, importamos o banco de dados a ser processado (limpado) utilizando a função *read.csv()* e atribuindo (<-) a um objeto que iremos chamar de "dados". Para importar, você só precisa especificar o caminho do diretório em que o arquivo está inserido. Como estamos utilizando o projeto de R, o diretório é onde o projeto está. Dessa forma, não há necessidade de dizer para o R qual é o seu diretório de trabalho. Logo, fica fácil importar os dados brutos pois sabemos que ele está na pasta "dados > raw > iris.csv". Dizemos isso para o R utilizando os nomes das pastas separados por barras e, por fim, o nome do arquivo (iris) e sua extensão (.csv).
  

 ```r

# Load data ---------------------------------------------------------------
dados <- read_excel("data/raw/fake_data.xlsx")

```
Agora que o banco de dados foi importado, podemos fazer um check up basico utilizando algumas funcoes.
  
```r

# 1. Basic checks --------------------------------------------------------------
nrow(dados)             # Quantas linhas (observacoes) tem no banco de dados?
str(dados)              # quais as classes das variaveis?
attributes(dados)       # quais atributos?
head(dados)             # Primeiras linhas do banco de dados.
any(duplicated(dados))  # Checar se tem linhas duplicadas.
any(is.na(dados))       # Checar se tem dado faltando (NA).

```
Às vezes, os nomes das variáveis não são fáceis de trabalhar, possuindo espaços, acentos, letras maiúsculas e minúsculas, e nomes confusos. Além de complicar o código, o nome de algumas variáveis pode bugá-lo (caso das acentuações de palavras em português). Então, vamos mudar o nome das variáveis utilizando a função *rename()* do pacote **dplyr**. Iremos deixar os nomes mais fáceis de trabalhar, deixando todas as letras minúsculas.
  
```r

# 3. Renomeando o nome das variaveis -------------------------------------------------------
head(dados)
dados2 <- rename(iris,                         #sua planilha bruta
                 sepal_length = Sepal.Length,  #nomes das variaveis (nome_novo = nome antigo)
                 sepal_width  = Sepal.Width,
                 petal_length = Petal.Length,
                 petal_width  = Petal.Width,
                 species      = Species)
head(dados2)

```
Agora vamos dizer para o R os tipos de nossas variaveis. Um problema muito comum, eh o R nao reconhecer que a variavel categorica, nao possui fatores, mesmo possuindo. Por exemplo, em "iris", temos a variavel categorica 'Species' com seus fatores (setosa, versicolor, virginica). Eh possivel que no seu banco de dados, o R nao reconheca isso, entao vamos utilizar a funcao *levels()* para verificar se o R entendeu quais sao os fatores. Se o R retornar NULL, voce precisa dizer para o R utilizando a funcao *as.factor()*.

```r

# 4. Fix factor variables-------------------------------------------------------
# check factor variable
levels(dados2$species)

# making factor variables
dados2$species <- as.factor(dados2$species) #atribuindo a variavel specie transformada a ela mesma.

# check factor variable
levels(dados2$species)

```

Agora podemos renomear o nome dos fatores de uma variavel categorica utilizando a funcao *recode_factor()*. Nesse processo podemos identificar erros de digitacao que ocorreram durante o planilhamento dos dados. Por exemplo, voce pode ter digitado "Macho", "macho" e "male" na variavel sexo durante o planilhamento. O R vai identificar os tres como sendo fatores diferentes mas na verdade sao o mesmo fator. Portanto eh necessario que seja padronizado.
  
```r
# 4.1 fix species factors

#check factors
levels(dados2$species)

#rename factors
dados2$species <- recode_factor(dados2$species,                 #variavel categorica
                                setosa = "iris_setosa",         #mudando nome setosa para iris_setosa
                                versicolor = "iris_versicolor",
                                virginica = "iris_virginica")

#check factors
levels(dados2$species)

```
  
Agora que limpamos nossos dados brutos, iremos exportar nossa planilha limpa. Perceba que o processo do script eh colocar a planilha bruta de um lado e sair limpa e bonitinha do outro. Eh com os dados processados que iremos trabalhar de fato. Vamos salvar sempre no formato csv por ser um formato mais simples, leve e estavel.
  
```r
# 8. Save processed data -----------------------------------------------------
write.csv(x = dados2,                                 #nome da planilha que voce quer exportar
          file = "data/processed/processed_iris.csv", #local e nome da planilha exportada
          row.names = FALSE)                          #sempre utilizaremos row.names = FALSE

```
  
O processo de manipulacao de dados no R eh bastante completo e existem diferentes formas de limpar seus dados brutos. O pacote **dplyr** possui funcoes capazes de selecionar variaveis, selecionar linhas, criar variaveis, criar subsets, entre outras. Para aprimorar seu script de limpeza de dados, voce precisara aprender sobre manipulacao de dados e incluir no processo, os codigos no seu script. Por sorte, existe muito material disponivel na internet sobre o assunto. Talvez algum dia eu crie um material sobre manipulacao de dados com dplyr, mas aqui esse nao eh meu objetivo. Meu objetivo eh simplesmente fornecer o esqueleto teorico, te dando base para crescer de forma mais direcionada.
  
Por fim, nao esqueca de salvar o script na pasta script com o nome '01_clean_raw_data'.
  
### Etapa 2: fazer analise
  
Com a planilha bruta processada, podemos realizar testes estatisticos para responder nossa hipotese. Vamos supor que nossa pergunta seja saber se existe diferenca entre o tamanho das petalas entre as tres especies. Organizaremos o script de analise de forma similar ao script de limpeza, ou seja, escreveremos um cabecalho, carregaremos pacotes, importaremos e analisaremos dados de forma organizada.
  
Vamos fazer um cabecalho para nosso script de analise.
  
 ```r
 
# Script to load and analyse processed data iris
# Author: Marilia T. Ericcson
# Data: 2019-11-07

```

Vamos criar o codigo para carregar os pacotes que iremos utilizar

 ```r
 
#Carregar pacotes
library(broom)

```
  
Dessa vez iremos importar a planilha limpa e processada. Note que o caminho de importacao eh similar ao caminho que exportamos no script de limpeza.
  
 ```r

# Load data ---------------------------------------------------------------
dados <- read.csv("data/processed/processed_iris.csv")

```
  
Vamos fazer um check basico.

```r

# 1. Basic checks --------------------------------------------------------------
head(dados)
str(dados)
leves(dados$species)

```

Vamos realizar uma analise para comparar a largura das petalas entre as especies. Para isso, iremos utilizar o teste nao parametrico de kruskal-wallis atraves da funcao kruskal.test(). Nessa funcao, voce precisa dizer qual sua variavel numerica de interesse em relacao a (~) sua variavel categorica e seus grupos (fatores). Veja que o p-value eh menor que 0.05, entao dizemos que existe diferenca da largura entre as tres especies.
  
```r

#realizando o teste
kw <- kruskal.test(iris$Sepal.Width ~ iris$Species)
kw

```
   
Vamos salvar o resultado em uma tabela organizada (tidy) utilizando a funcao *tidy()* do pacote **broom**.

```r

#Ajeitando tabela para formato tidy
table_kw <- tidy(kw_test)
table_kw

```

Agora salvaremos essa tabela na nossa pasta outputs em tables.

```r

#Exportando resultado
write.csv(x = table_kw,                                 
          file = "outputs/tables/resultado_kw.csv",
          row.names = FALSE)

```
Maravilha! Ja temos nosso segundo script pronto. Agora eh so salva-lo na pasta script com o nome: '02_kruskal_test'.
  
### Etapa 3: criar grafico
  
Agora vamos criar o grafico para representar nosso resultado de que existe diferenca da largura das petadas entre as especies de iris.
  
```r
 
# Script to load and analyse processed data iris
# Author: Marilia T. Ericcson
# Data: 2019-11-07
 
#Carregar pacotes
library(ggplot2)

# Load data ---------------------------------------------------------------
dados <- read.csv("data/processed/processed_iris.csv")

# 1. Basic checks --------------------------------------------------------------
head(dados)
str(dados)
leves(dados$species)

# 2. Criar grafico boxplot -----------------------------------------------------

grafico <- ggplot(dados, aes(x = species, y = petal_width))+
  geom_boxplot()

grafico

# 3. Salvando grafico ----------------------------------------------------------

ggsave(plot = grafico,    #nome do grafico
       filename = "output/figures/Grafico_boxplot.png", #nome do grafico exportado
       width = 10,                             #largura do grafico
       height = 10,                            #Altura do grafico
       dpi = 300)                              #resolucao do grafico

```

```{r graph, fig.show='asis',fig.cap='ggplot2', echo=FALSE}

#Carregar pacotes
library(ggplot2)
data(iris)

ggplot(iris, aes(x = Species, y = Petal.Width))+
  geom_boxplot()

```
  
Voce acabou de criar um grafico utilizando o pacote ggplot2 que eh o pacote mais utilizado para producao de graficos no R. O codigo pode parecer um pouco confuso no inicio, mas nao precisa estudar muito para perceber que ele eh muito simples e intuitivo. Para aprender mais sobre graficos, sugiro os livros: https://rkabacoff.github.io/datavis/ e https://r-graphics.org/
  
Nao esqueca de salvar o script com o nome '03_grafico'
#Etapa 4: Replicabilidade
  
O seu projeto esta organizado de forma que se torna facil a replicabilidade em qualquer computador gerando todos seus outputs (tabelas e figuras) automaticamente! Para isso, voce precisa manter e JAMAIS deletar ou modificar seus dados brutos (pasta raw). Todos os demais arquivos podem ser produzidos com um click a partir dos seus dados brutos, portanto, podem ser deletados. Isso se torna util ao compartilhar seus dados com alguem, em que voce pode zipar todo seu projeto, enviar para um contribuidor e ele podera ter acesso a tudo rodando apenas um script. Eh esse script que iremos fazer agora.

```r
# Script to run all project code
# Importante: reinicie o R antes de rodar esse script session > restart R

# Start----
# 1. Run all scripts again on a fresh R section---------------------------------
# 1.1 Load and clean data----
source(file = "script/01_clean_raw_data.R")

# 1.2 Run analysis -------------------------------------------------------------
source(file = "script/02_kruskal_test.R")

# 1.3 Plot figures--------------------------------------------------------------
source(file = "script/03_grafico.R")

```
  
Ao rodar esse codigo, todos os seus scripts sao rodados e todos os seus outputs e planilhas processadas sao geradas. Mas lembre, seu dado bruto contido na pasta data/raw, nao pode ser deletada ou modificada.
  
Salve esse script com o nome "run_project".
  

